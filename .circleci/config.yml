####
# Default job.
# This job simply defines the android image, some environment variables
# and stuff that all jobs should have
##
default: &defaultJob
  # The docker image all jobs that inherit from us will have (Which should be all of them)
  docker:
      - image: circleci/android:api-28
##
# We define a job for building. This job will be in charge of running:
# - Install mobile-cd build automation: 'kelli'
# - Run code analysis for a specific module
# - Run tests for a specific module
# - Run an assemble for a specific module
# - Run a build analysis for a specific module
# - Specifying a place for storing artifacts and test results.
##
build-job: &buildJob
  # It will inherit the defaultJob.
  <<: *defaultJob
  steps:
      # Checkout to our repo and add the ssh keys for doing git stuff
      - checkout
      - add_ssh_keys
      # Restore the cache if a hashed build.gradle is found as key
      - restore_cache:
          key: buildscript-{{ checksum "build.gradle" }}
      - restore_cache:
          key: gradlew-{{ checksum "./gradle/wrapper/gradle-wrapper.properties" }}
      - restore_cache:
          key: dependencies-{{ checksum "base/build.gradle" }}
      - run:
          name: Install Mobile Requirements
          command: eval $GET_MOBILE_CD | ruby
      - run:
          name: Run Code Analysis
          command: kelli code-analyzer --module $MODULE
      - run:
          name: Run Tests
          command: kelli test --module $MODULE
      - run:
          name: Run Assemble
          command: kelli assemble --module $MODULE
      - run:
          name: Run Build Analysis
          command: kelli build-analyzer --module $MODULE
      # Save the cache for this build.gradle
      - save_cache:
          paths:
          - ~/.gradle
          key: buildscript-{{ checksum "build.gradle" }}
      - save_cache:
          paths:
          - ./gradle
          key: gradlew-{{ checksum "./gradle/wrapper/gradle-wrapper.properties" }}
      - save_cache:
          paths:
          - ./.gradle
          - ~/.android/build-cache/
          key: dependencies-{{ checksum "base/build.gradle" }}
      # Setup store paths, everything inside $CI_ARTIFACTS_DIR will be uploaded.
      # Since 2.0 still doesnt support envvars in store_artifacts, we use its value directly....
      - store_artifacts:
          path: "mobile-cd/artifacts"
##
# We define a job for deploying. This job will be in charge of running:
# - Install mobile-cd build automation: 'kelli'
# - Run deploy of a lib | application as release
##
deploy-release-job: &deployReleaseJob
  <<: *defaultJob
  steps:
      # Checkout to our repo and add the ssh keys for doing git stuff
      - checkout
      - add_ssh_keys
      - run:
          name: Install Mobile Requirements
          command: eval $GET_MOBILE_CD | ruby
      - run:
          name: Run Deploy
          command: kelli deploy lib --release
##
# We define our default workflow
# This workflow will be used by our default builds
# The following workflow runs on every branch except master or release/?
##
default-workflow: &defaultWorkflow
  filters:
    branches:
      ignore:
        - master
        - /release\/.*$/

##
# Create our jobs, making them inherit from the defined jobs
# The ones that will inherit from buildJob need to create the environment variable
# MODULE. Check the steps defined for that job so you understand why :)
##
version: 2
jobs:
  base:
    <<: *buildJob
    environment:
      MODULE: base
  build: # Do NOT rename this "build" job because Circle CI expects this name.
    <<: *deployReleaseJob

##
# We define here workflows. We will add all our jobs
# to a common workflow, and for each job of the workflow we will make it
# inherit its properties from a specific workflow
##
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - base:
          <<: *defaultWorkflow
